---
- name: Create Progres user &
  hosts: all
  gather_facts: "{{ ANSIBLE_GATHERING }}"
  vars: 
    dbrole: "{{ DB_ROLE }}"
    dbpass: "{{ DB_PASS }}"
  
  tasks:
    - name: Create postgres user for progress
      become: yes
      become_user: postgres
      postgresql_user:
        name: "{{ dbrole }}"
        password: "{{ dbpass }}"
      role_attr_flags: SUPERUSER

    - name: Ensure we have access from the new user
      become: yes
      become_user: postgres
      postgresql_privs:
        db: test
        role: "{{ dbrole }}"
        objs: ALL_IN_SCHEMA
        privs: SELECT,INSERT,UPDATE,DELETE
    

